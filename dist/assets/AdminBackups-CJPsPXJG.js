import{j as e,m as a,P as t,a as l}from"./index-Ba4satG4.js";import{a as r,R as s}from"./vendor-ui-BS_k7u0B.js";import"./vendor-react-CBIIZEva.js";import"./vendor-firebase-RMoShlIt.js";const i=()=>{var i,n,o,c,d,p,u;const[m,h]=r.useState([]),[x,y]=r.useState(!0),[f,g]=r.useState(null),[v,b]=r.useState(!1),[w,j]=r.useState(""),[N,k]=r.useState(null),[R,C]=r.useState(null),[S,E]=r.useState(!1),[A,B]=r.useState(()=>{try{return JSON.parse(localStorage.getItem("mazen:latestAutoBackup")||"null")}catch(e){return null}}),[P,L]=r.useState(()=>{try{return JSON.parse(localStorage.getItem("mazen:latestAutoBackupPayload")||"null")}catch(e){return null}}),O=s.useRef(null),[U,T]=r.useState(!0),[I,J]=r.useState(null),[D,z]=r.useState(null),[F,_]=r.useState(!1);r.useEffect(()=>{let e=!0;(async()=>{y(!0);const t=await a.listBackups();e&&(h(t.sort((e,a)=>{var t,l;return((null==(t=a.meta)?void 0:t.createdAt)||0)-((null==(l=e.meta)?void 0:l.createdAt)||0)})),y(!1))})();const t=()=>{try{B(JSON.parse(localStorage.getItem("mazen:latestAutoBackup")||"null")),L(JSON.parse(localStorage.getItem("mazen:latestAutoBackupPayload")||"null"))}catch(e){}};return window.addEventListener("mazin:backup",t),()=>{e=!1,window.removeEventListener("mazin:backup",t)}},[]);const M=async(e,t="merge")=>{var r,s;if("replace"!==t||"REPLACE"===w){if(confirm(`Trigger server-side ${t} restore for ${e.id}?`)){C("Preparing payload..."),b(!0);try{const i=e.payload||await a.getBackupPayload(e.id,e=>k(e));if(!i)return void alert("No payload");const n=l.currentUser;if(!n)return void alert("Not signed in. Re-auth and try again.");C("Getting auth token...");const o=await n.getIdToken(!0);C("Calling server restore...");const c=(null==(s=null==(r=import.meta)?void 0:r.env)?void 0:s.VITE_RESTORE_URL)||"/__/functions/restore",d=await fetch(c+"?mode="+t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+o},body:JSON.stringify(i)}),p=await d.json();d.ok?alert("Server restore started: "+JSON.stringify(p)):alert("Server restore failed: "+(p.error||d.status))}catch(i){alert("Server restore error")}finally{b(!1),C(null),k(null)}}}else alert("Type REPLACE to confirm")};return e.jsxs("div",{className:"p-4 bg-white rounded-lg shadow-sm",children:[e.jsx("h3",{className:"font-bold text-lg mb-3",children:"Backups"}),e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("button",{onClick:async()=>{if(confirm("Create a new backup now?")){E(!0),C("Exporting data...");try{const e=await a.exportData();C("Uploading backup file...");const t=await a.saveBackupFile(e,e=>k(e));C("Saving backup record...");const l={meta:{version:e.meta.version,createdAt:e.meta.createdAt,fileName:t.path.split("/").pop()},storagePath:t.path,fileUrl:t.url,sizeBytes:t.sizeBytes,performedBy:"admin"},r=await a.saveBackupRecord(l),s=await a.listBackups();h(s.sort((e,a)=>{var t,l;return((null==(t=a.meta)?void 0:t.createdAt)||0)-((null==(l=e.meta)?void 0:l.createdAt)||0)})),alert("Backup created: "+r)}catch(e){alert("Create backup failed")}finally{E(!1),k(null),C(null)}}},disabled:S||v,className:"px-3 py-1 bg-blue-600 text-white rounded",children:S?"Creating...":"Create Backup"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:async()=>{if(confirm("Create a pre-restore snapshot (stored as a lightweight backup record)?")){C("Creating pre-restore snapshot...");try{const e=await a.preRestoreBackup();if(e&&e.id){J({id:e.id});const t=await a.listBackups();h(t.sort((e,a)=>{var t,l;return((null==(t=a.meta)?void 0:t.createdAt)||0)-((null==(l=e.meta)?void 0:l.createdAt)||0)})),alert("Pre-restore snapshot created: "+e.id)}else alert("Pre-restore snapshot created")}catch(e){alert("Pre-snapshot failed")}finally{C(null)}}},disabled:v,className:"px-3 py-1 bg-yellow-500 text-white rounded",children:"Create Pre-snapshot"}),I&&e.jsxs("div",{className:"text-xs text-gray-600",children:["Last pre-snapshot: ",e.jsx("code",{className:"bg-white px-2 py-1 rounded",children:I.id})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:async()=>{var e;try{_(!0);const{reauthWithGoogle:a,auth:t}=require("../../firebase");await a();const l=t.currentUser;if(l){const a=await l.getIdTokenResult(!0);z(!(!a.claims||!a.claims.admin)),(null==(e=a.claims)?void 0:e.admin)||alert("Signed in but admin claim not present")}}catch(a){alert("Re-authentication failed")}finally{_(!1)}},disabled:F,className:"px-3 py-1 bg-green-600 text-white rounded",children:F?"Auth...":"Re-auth (Admin)"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["Admin: ",null===D?"unknown":D?"yes":"no"]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:U,onChange:e=>T(e.target.checked)}),e.jsx("span",{className:"text-xs",children:"Auto pre-restore snapshot"})]}),e.jsxs("label",{className:"px-3 py-1 bg-white border rounded cursor-pointer",children:["Upload JSON",e.jsx("input",{ref:O,onChange:async e=>{var t;const l=null==(t=e.target.files)?void 0:t[0];if(l)try{const e=await l.text(),t=JSON.parse(e);if(!t||"object"!=typeof t)return void alert("Invalid JSON");if(!(t.meta&&(t.items||t.categories||t.sections||t.profiles)||confirm("File does not look like a full export. Continue?")))return;const s=confirm("Import in REPLACE mode? OK = REPLACE, Cancel = MERGE")?"replace":"merge";if("replace"===s&&!confirm("REPLACE is destructive. Are you absolutely sure?"))return;if(U){C("Creating pre-restore snapshot...");try{await a.preRestoreBackup()}catch(r){}}if(b(!0),C("Importing payload..."),"replace"===s){const e=await a.replaceFromExport(t);e&&e.success?alert("Replace successful"):e&&e.rolledBack?alert("Replace failed but rollback succeeded"):alert("Replace failed")}else{await a.restoreFromExport(t,{mode:"merge"});alert("Merge complete")}}catch(s){alert("Import failed: "+String(s))}finally{b(!1),C(null),O.current&&(O.current.value="")}},type:"file",accept:".json,application/json",className:"hidden"})]}),A&&e.jsxs("div",{className:"p-3 border rounded bg-yellow-50 flex items-center justify-between w-full",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-bold",children:["Local Auto-backup ",(null==(i=null==A?void 0:A.meta)?void 0:i.version)?`• v${A.meta.version}`:""]}),e.jsx("div",{className:"text-xs text-gray-600",children:(null==A?void 0:A.timestamp)?new Date(A.timestamp).toLocaleString():""})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{P?g({id:"local",meta:P.meta,payload:P}):alert("No local payload stored.")},className:"px-3 py-1 bg-white border rounded",children:"Preview"}),e.jsx("button",{onClick:()=>{if(!P)return void alert("No local payload stored.");const e=P,a=`local-auto-backup_${new Date(e.meta.createdAt).toISOString().replace(/[:.]/g,"-")}_v${e.meta.version}.json`,t=JSON.stringify(e,null,2),l=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(l),s=document.createElement("a");s.href=r,s.download=a,document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(r)},className:"px-3 py-1 bg-white border rounded",children:"Download"}),e.jsx("button",{onClick:async()=>{if(P){if(confirm("Restore from local auto-backup (REPLACE)? This will replace current menu.")){if(U){C("Creating pre-restore snapshot...");try{await a.preRestoreBackup()}catch(e){}}b(!0);try{const e=await a.replaceFromExport(P);e&&e.success?alert("Replace successful"):alert("Replace failed")}catch(e){alert("Restore failed")}finally{b(!1),C(null)}}}else alert("No local payload stored.")},className:"px-3 py-1 bg-red-600 text-white rounded",children:"Restore"})]})]}),R&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx("div",{children:R}),e.jsx("div",{style:{width:120},children:e.jsx(t,{percent:N??0})})]})]}),x?e.jsx("div",{className:"text-sm text-gray-500",children:"Loading..."}):e.jsx("div",{className:"space-y-3",children:0===m.length?e.jsx("div",{className:"text-gray-500",children:"No backups found."}):e.jsx("div",{className:"space-y-2",children:m.map(t=>{var l,r,s;return e.jsxs("div",{className:"p-3 border rounded flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-bold",children:[(null==(l=t.meta)?void 0:l.fileName)||t.id," ",t.fileUrl&&e.jsx("a",{href:t.fileUrl,target:"_blank",rel:"noreferrer",className:"text-xs text-green-600 ml-2",children:"Open File"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[t.performedBy||"admin"," • ",null==(r=t.meta)?void 0:r.version," • ",(null==(s=t.meta)?void 0:s.createdAt)?new Date(t.meta.createdAt).toLocaleString():""]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>(async e=>{try{C("Downloading payload..."),k(0);const t=e.payload||await a.getBackupPayload(e.id,e=>k(e));if(!t)return alert("No payload"),k(null),void C(null);g({...e,payload:t})}catch(t){alert("Failed to load payload")}finally{k(null),C(null)}})(t),disabled:null!==N||v,className:"px-3 py-1 bg-white border rounded disabled:opacity-50",children:"Preview"}),e.jsx("button",{onClick:()=>(async e=>{var t;try{if(e.fileUrl)return void window.open(e.fileUrl,"_blank");const l=e.payload||await a.getBackupPayload(e.id);if(!l)return void alert("No payload found");const r=(null==(t=e.meta)?void 0:t.fileName)||`backup_${e.id}.json`,s=JSON.stringify(l,null,2),i=new Blob([s],{type:"application/json"}),n=URL.createObjectURL(i),o=document.createElement("a");o.href=n,o.download=r,document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(n)}catch(l){alert("Download failed")}})(t),disabled:null!==N||v,className:"px-3 py-1 bg-white border rounded disabled:opacity-50",children:"Download"}),e.jsx("button",{onClick:()=>(async e=>{if(confirm("Apply merge? This will upsert items and may overwrite existing entries.")){b(!0),C("Downloading payload for merge..."),k(0);try{const l=e.payload||await a.getBackupPayload(e.id,e=>k(e));if(U){C("Creating pre-restore snapshot...");try{await a.preRestoreBackup()}catch(t){}}C("Applying merge..."),await a.restoreFromExport(l,{mode:"merge"}),alert("Merge complete")}catch(t){alert("Merge failed")}finally{b(!1),k(null),C(null)}}})(t),disabled:v||null!==N,className:"px-3 py-1 bg-[#231f20] text-[#c68a53] rounded disabled:opacity-50",children:"Merge"}),e.jsx("button",{onClick:()=>M(t,"merge"),disabled:v||null!==N,className:"px-3 py-1 bg-[#1f6feb] text-white rounded disabled:opacity-50",children:"Server Merge"}),e.jsx("button",{onClick:()=>M(t,"replace"),disabled:v||null!==N,className:"px-3 py-1 bg-red-700 text-white rounded disabled:opacity-50",children:"Server Replace"})]})]},t.id)})})}),f&&e.jsxs("div",{className:"mt-4 p-3 bg-gray-50 rounded",children:[e.jsxs("h4",{className:"font-bold",children:["Preview: ",(null==(n=f.meta)?void 0:n.fileName)||f.id]}),e.jsxs("div",{className:"text-sm text-gray-700",children:["Items: ",((null==(o=f.payload)?void 0:o.items)||[]).length," • Categories: ",((null==(c=f.payload)?void 0:c.categories)||[]).length," • Profiles: ",((null==(d=f.payload)?void 0:d.profiles)||[]).length]}),R&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-sm text-gray-600 mb-2",children:R}),e.jsx(t,{percent:N??0})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"mb-2 text-xs text-gray-500",children:["Type ",e.jsx("code",{className:"bg-white px-2 py-1 rounded",children:"REPLACE"})," to enable destructive replace:"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:w,onChange:e=>j(e.target.value),className:"p-2 rounded border w-48",placeholder:"Type REPLACE to confirm"}),e.jsx("button",{disabled:v||"REPLACE"!==w,onClick:()=>(async e=>{if("REPLACE"===w){if(confirm("This will replace entire menu data and is destructive. Continue?")){b(!0),C("Downloading payload for replace..."),k(0);try{const l=e.payload||await a.getBackupPayload(e.id,e=>k(e));if(U){C("Creating pre-restore snapshot...");try{await a.preRestoreBackup()}catch(t){}}C("Applying replace (this may take a while)...");const r=await a.replaceFromExport(l);r&&r.success?alert("Replace successful"):r&&r.rolledBack?alert("Replace failed but rollback succeeded, check console"):alert("Replace failed")}catch(t){alert("Replace failed")}finally{b(!1),j(""),k(null),C(null)}}}else alert("Type REPLACE to confirm")})(f),className:"px-3 py-2 bg-red-600 text-white rounded",children:v?"Replacing...":"Replace"})]}),e.jsx("div",{className:"mt-3 text-xs text-gray-500",children:"Preview payload (truncated):"}),e.jsx("pre",{className:"mt-2 max-h-60 overflow-auto text-xs bg-white p-2 border rounded",children:JSON.stringify({items:((null==(p=f.payload)?void 0:p.items)||[]).slice(0,10),categories:((null==(u=f.payload)?void 0:u.categories)||[]).slice(0,10)},null,2)})]})]})]})};export{i as default};
